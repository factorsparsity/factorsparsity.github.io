<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Video Player PWA</title>
    <!-- Link to the external manifest file -->
    <link rel="manifest" href="manifest.json">
    <!-- SLDS is typically loaded within the Salesforce platform, but for a standalone PWA, you would link to a CDN or a local copy -->
    <link rel="stylesheet" href="https://www.lightningdesignsystem.com/assets/styles/lightning-design-system.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="slds-p-around_medium slds-m-top_large">

    <div class="slds-card slds-p-around_large slds-max-small-size--1-of-1 slds-m-bottom_medium" style="max-width: 60rem; margin: auto;">
        <div class="slds-card__header slds-grid slds-p-bottom_medium">
            <h1 class="slds-text-heading_large slds-text-color_success">Offline Video Sync PWA</h1>
        </div>
        
        <!-- Status Message Box -->
        <div id="message-box" class="slds-notify slds-notify_alert slds-theme_alert-texture hidden" role="alert">
            <span class="slds-assistive-text">Info</span>
            <span class="slds-icon_container slds-icon-utility-info slds-m-right_x-small">
                <svg class="slds-icon slds-icon_x-small" aria-hidden="true">
                    <use xlink:href="https://www.lightningdesignsystem.com/assets/icons/utility-sprite/svg/symbols.svg#info"></use>
                </svg>
            </span>
            <p id="message-text"></p>
        </div>

        <!-- Video Player Section -->
        <div id="video-player-container" class="slds-p-around_medium hidden">
            <video id="video-player" controls class="slds-p-around_x-small" style="width: 100%;"></video>
        </div>

        <!-- Main Video List Section -->
        <div class="slds-grid slds-grid_vertical-align-center slds-m-vertical_medium">
            <h2 class="slds-text-heading_medium slds-m-right_large">Video List</h2>
            <div class="slds-button_group" role="group">
                <button id="sync-all-btn" class="slds-button slds-button_brand">
                    <svg class="slds-button__icon slds-button__icon_left" aria-hidden="true">
                        <use xlink:href="https://www.lightningdesignsystem.com/assets/icons/utility-sprite/svg/symbols.svg#sync"></use>
                    </svg>
                    Sync All Videos
                </button>
            </div>
        </div>

        <!-- Video Table -->
        <div class="slds-table_edit">
            <table class="slds-table slds-table_bordered slds-table_cell-buffer">
                <thead>
                    <tr class="slds-line-height_reset">
                        <th class="slds-text-title_caps" scope="col">Title</th>
                        <th class="slds-text-title_caps" scope="col">Link</th>
                        <th class="slds-text-title_caps" scope="col">Offline Status</th>
                        <th class="slds-text-title_caps" scope="col" style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="video-table-body">
                    <!-- Video rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- JavaScript for PWA Logic -->
    <script>
        // --- 1. MOCK VIDEO DATA & STATE MANAGEMENT ---
        const videoData = [{
            id: 'video-1',
            title: 'Introduction to PWAs',
            url: 'video1.mp4',
            isOffline: false
        }, {
            id: 'video-2',
            title: 'Service Worker Deep Dive',
            url: 'video2.mp4',
            isOffline: false
        }, {
            id: 'video-3',
            title: 'IndexedDB for Fun and Profit',
            url: 'video3.mp4',
            isOffline: false
        }];

        // --- 2. UI & EVENT HANDLING ---
        const videoTableBody = document.getElementById('video-table-body');
        const syncAllBtn = document.getElementById('sync-all-btn');
        const videoPlayerContainer = document.getElementById('video-player-container');
        const videoPlayer = document.getElementById('video-player');
        const messageBox = document.getElementById('message-box');

        const showMessage = (text, type = 'info') => {
            messageBox.textContent = text;
            messageBox.className = `block slds-notify slds-notify_alert slds-theme_alert-texture slds-m-bottom_medium`;
            if (type === 'success') {
                messageBox.classList.add('slds-theme_success');
            } else if (type === 'error') {
                messageBox.classList.add('slds-theme_error');
            } else {
                messageBox.classList.add('slds-theme_info');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        };

        const renderTable = () => {
            videoTableBody.innerHTML = '';
            videoData.forEach(video => {
                const row = document.createElement('tr');
                row.className = 'slds-hint-parent';
                row.innerHTML = `
                    <td data-label="Title">${video.title}</td>
                    <td data-label="Link"><a href="#${video.id}" class="slds-text-link" onclick="playVideo('${video.id}')">Watch</a></td>
                    <td data-label="Offline Status"><span id="${video.id}-status" class="slds-badge slds-theme_default">${video.isOffline ? 'Available Offline' : 'Online Only'}</span></td>
                    <td data-label="Actions" style="text-align: right;">
                        <button id="${video.id}-sync-btn" class="slds-button slds-button_neutral sync-btn" data-video-id="${video.id}" ${video.isOffline ? 'disabled' : ''}>
                            ${video.isOffline ? 'Synced' : 'Sync'}
                        </button>
                    </td>
                `;
                videoTableBody.appendChild(row);
            });
            attachSyncListeners();
        };

        const attachSyncListeners = () => {
            document.querySelectorAll('.sync-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const videoId = e.target.dataset.videoId;
                    if (videoId) {
                        syncVideo(videoId);
                    }
                };
            });
        };

        const playVideo = async (videoId) => {
            const video = videoData.find(v => v.id === videoId);
            if (!video) {
                showMessage('Video not found.', 'error');
                return;
            }
            videoPlayer.src = video.url;
            showMessage(`Attempting to play video: ${video.title}. The service worker will handle caching.`, 'info');
            videoPlayerContainer.classList.remove('hidden');
            videoPlayer.load();
        };

        const syncVideo = async (videoId) => {
            const video = videoData.find(v => v.id === videoId);
            if (!video) return;
            const syncBtn = document.getElementById(`${videoId}-sync-btn`);
            const statusSpan = document.getElementById(`${videoId}-status`);
            syncBtn.disabled = true;
            syncBtn.textContent = 'Syncing...';
            statusSpan.textContent = 'Syncing...';
            statusSpan.className = 'slds-badge slds-theme_warning';

            try {
                const response = await fetch(video.url);
                if (!response.ok) {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
                video.isOffline = true;
                syncBtn.disabled = true;
                syncBtn.textContent = 'Synced';
                statusSpan.textContent = 'Available Offline';
                statusSpan.className = 'slds-badge slds-theme_success';
                showMessage(`Video '${video.title}' synced successfully!`, 'success');
            } catch (error) {
                console.error(`Failed to sync video: ${video.title}`, error);
                showMessage(`Failed to sync video '${video.title}'. The video file was not found or could not be accessed. Please ensure the file exists at: ${video.url}`, 'error');
                video.isOffline = false;
                syncBtn.disabled = false;
                syncBtn.textContent = 'Sync';
                statusSpan.textContent = 'Online Only';
                statusSpan.className = 'slds-badge slds-theme_default';
            }
        };

        const syncAllVideos = async () => {
            showMessage('Initiated sync for all videos.', 'info');
            for (const video of videoData) {
                if (!video.isOffline) {
                    await syncVideo(video.id);
                }
            }
        };
        
        const handleDeepLink = () => {
            const videoId = window.location.hash.slice(1);
            if (videoId) {
                playVideo(videoId);
            }
        };

        const DB_NAME = 'offline-videos-db';
        const DB_VERSION = 1;
        const DB_STORE_NAME = 'videos';
        let db;

        const openDatabase = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(DB_STORE_NAME)) {
                        db.createObjectStore(DB_STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        const checkOfflineStatus = async () => {
            const db = await openDatabase();
            const transaction = db.transaction([DB_STORE_NAME], 'readonly');
            const store = transaction.objectStore(DB_STORE_NAME);
            const syncedVideoUrls = await new Promise((resolve, reject) => {
                const request = store.getAllKeys();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject([]);
            });

            videoData.forEach(video => {
                video.isOffline = syncedVideoUrls.includes(video.url);
            });
            renderTable();
        };

        const initializeApp = async () => {
            try {
                db = await openDatabase();
                await checkOfflineStatus();
                renderTable();
                handleDeepLink();
                syncAllBtn.onclick = syncAllVideos;
            } catch (error) {
                console.error('App initialization failed:', error);
                showMessage('App failed to load. Check console for details.', 'error');
            }
        };

        window.addEventListener('load', () => {
            console.log("App load event fired.");
            if ('serviceWorker' in navigator && window.location.protocol !== 'blob:') {
                navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    initializeApp();
                })
                .catch(err => {
                    console.error('ServiceWorker registration failed: ', err);
                    showMessage('App failed to load. Check console for details.', 'error');
                    initializeApp(); // Run initialization anyway for a fallback UI
                });
            } else {
                console.warn('Service workers are not supported or available in this browser. PWA features will not be available.');
                initializeApp(); // Run initialization without service worker support
            }
        });
        window.addEventListener('hashchange', handleDeepLink);
    </script>
</body>
</html>
