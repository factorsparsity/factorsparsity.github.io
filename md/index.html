<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<title>System-1 Markdown</title>

<style>
/* === Embedded Local Font References === */
@font-face {
  font-family: 'Courier Prime Local';
  src: url('./courier-prime.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
@font-face {
  font-family: 'Chicago Local';
  src: url('./chicago.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

:root {
  --font-default: 'Chicago Local', 'Chicago', 'Monaco', monospace;
  --font-alt: 'Courier Prime Local', 'Courier Prime', monospace;
  --bg-light: #ffffff;
  --bg-dark: #000000;
  --fg-light: #000000;
  --fg-dark: #ffffff;
}

body {
  margin: 0;
  font-family: var(--font-default);
  background-color: var(--bg-light);
  color: var(--fg-light);
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* === Menu Bar === */
#menubar {
  display: flex;
  align-items: center;
  background: #ffffff;
  color: black;
  border-bottom: 1px solid #000;
  padding: 0 8px;
  font-size: 14px;
  user-select: none;
}

.menu {
  position: relative;
  padding: 4px 8px;
  cursor: default;
}

.menu:hover {
  background: #000;
  color: #fff;
}

.dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  background: #fff;
  color: black;
  border: 1px solid #000;
  min-width: 160px;
  white-space: nowrap;
}

.menu:hover .dropdown {
  display: block;
}

.dropdown div {
  padding: 4px 8px;
}

.dropdown div:hover {
  background: #000;
  color: #fff;
}

#status {
  margin-left: auto;
  font-size: 12px;
  padding-left: 8px;
}

/* === Editor === */
#editor {
  flex: 1;
  padding: 8px;
  font-family: var(--font-alt);
  font-size: 14px;
  line-height: 1.4;
  outline: none;
  border: none;
  resize: none;
  background: transparent;
  color: inherit;
}

.dark {
  background-color: var(--bg-dark);
  color: var(--fg-dark);
}
</style>
</head>
<body>

<div id="menubar">
  <div class="menu">File
    <div class="dropdown">
      <div data-action="new">New ⌘N</div>
      <div data-action="open">Open ⌘O</div>
      <div data-action="save">Save ⌘S</div>
    </div>
  </div>
  <div class="menu">Edit
    <div class="dropdown">
      <div data-action="undo">Undo ⌘Z</div>
      <div data-action="redo">Redo ⇧⌘Z</div>
      <div data-action="copy">Copy ⌘C</div>
      <div data-action="paste">Paste ⌘V</div>
    </div>
  </div>
  <div class="menu">Markdown
    <div class="dropdown">
      <div data-action="bold">Bold ⌘B</div>
      <div data-action="italic">Italic ⌘I</div>
      <div data-action="bullets">Bullets ⌘U</div>
      <div data-action="h1">H1</div>
      <div data-action="h2">H2</div>
      <div data-action="link">Link ⌘K</div>
    </div>
  </div>
  <div class="menu">View
    <div class="dropdown">
      <div data-action="toggle-theme">Toggle Dark/Light</div>
      <div data-action="preview">Preview</div>
      <div data-action="toggle-font">Toggle Font</div>
    </div>
  </div>
  <div id="status">Loaded</div>
</div>

<textarea id="editor" spellcheck="false"></textarea>

<script>
// === Service Worker Registration ===
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(console.error);
}

const editor = document.getElementById('editor');
const statusEl = document.getElementById('status');
let currentFont = 0;
const fonts = ['var(--font-default)', 'var(--font-alt)'];

// === Autosave Setup ===
const STORAGE_KEY = 'system1-md-content';
function saveContent() {
  statusEl.textContent = 'Saving...';
  localStorage.setItem(STORAGE_KEY, editor.value);
  setTimeout(() => statusEl.textContent = 'Saved', 300);
}
function loadContent() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved !== null) editor.value = saved;
}
editor.addEventListener('input', () => {
  saveContent();
});
window.addEventListener('load', loadContent);

// === Menu Actions ===
document.querySelectorAll('.dropdown div').forEach(item => {
  item.addEventListener('click', () => {
    const action = item.dataset.action;
    handleAction(action);
  });
});

function handleAction(action) {
  switch (action) {
    case 'new':
      editor.value = '';
      saveContent();
      break;
    case 'open':
      openFile();
      break;
    case 'save':
      downloadFile();
      break;
    case 'undo':
      document.execCommand('undo');
      break;
    case 'redo':
      document.execCommand('redo');
      break;
    case 'copy':
      document.execCommand('copy');
      break;
    case 'paste':
      document.execCommand('paste');
      break;
    case 'bold':
      wrapSelection('**','**');
      break;
    case 'italic':
      wrapSelection('*','*');
      break;
    case 'bullets':
      prependLines('- ');
      break;
    case 'h1':
      prependLines('# ');
      break;
    case 'h2':
      prependLines('## ');
      break;
    case 'link':
      wrapSelection('[','](url)');
      break;
    case 'toggle-theme':
      document.body.classList.toggle('dark');
      break;
    case 'preview':
      previewMarkdown();
      break;
    case 'toggle-font':
      currentFont = (currentFont + 1) % fonts.length;
      editor.style.fontFamily = fonts[currentFont];
      break;
  }
}

function wrapSelection(before, after) {
  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  const selected = editor.value.slice(start, end);
  editor.setRangeText(before + selected + after, start, end, 'end');
  saveContent();
}

function prependLines(prefix) {
  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  const selected = editor.value.slice(start, end);
  const modified = selected.split('\n').map(line => prefix + line).join('\n');
  editor.setRangeText(modified, start, end, 'end');
  saveContent();
}

function openFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.md,.txt';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      editor.value = reader.result;
      saveContent();
      statusEl.textContent = 'Loaded';
    };
    reader.readAsText(file);
  };
  input.click();
}

function downloadFile() {
  const blob = new Blob([editor.value], {type: 'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'document.md';
  a.click();
  URL.revokeObjectURL(a.href);
}

function previewMarkdown() {
  const win = window.open('', '_blank');
  win.document.write('<pre>' + editor.value.replace(/</g,'&lt;') + '</pre>');
}
</script>
</body>
</html>
