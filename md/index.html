<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdown Editor - System 1 Style</title>
<link rel="manifest" href="manifest.json">
<style>
  /* System 1 styling: black & white, thin borders, bitmap-like font */
  body { margin: 0; font-family: Monaco, monospace; background: white; color: black; }
  .menubar, .window { border: 1px solid black; }
  .menubar { display: flex; background: #eeeeee; padding: 2px 4px; user-select: none; }
  .menu { position: relative; margin-right: 8px; cursor: default; }
  .menu:hover .dropdown, .menu.open .dropdown { display: block; }
  .dropdown { display: none; position: absolute; top: 100%; left: 0; border: 1px solid black; background: white; }
  .dropdown div { padding: 2px 8px; cursor: default; }
  .dropdown div:hover { background: #cccccc; }
  .window { margin: 4px; padding: 4px; height: calc(100vh - 32px); box-sizing: border-box; display: flex; flex-direction: column; }
  .toolbar { border-bottom: 1px solid black; padding-bottom: 2px; margin-bottom: 4px; }
  #container { flex: 1; display: flex; flex-direction: column; }
  #editor, #preview { flex: 1; width: 100%; border: 1px solid black; padding: 4px; font-size: 14px; line-height: 1.2; display: none; box-sizing: border-box; }
  #editor.visible, #preview.visible { display: block; }
</style>
</head>
<body>
  <div class="menubar">
    <div class="menu" data-menu="File">File
      <div class="dropdown">
        <div data-action="new">New ⌘N</div>
        <div data-action="open">Open ⌘O</div>
        <div data-action="save">Save ⌘S</div>
      </div>
    </div>
    <div class="menu" data-menu="Edit">Edit
      <div class="dropdown">
        <div data-action="bold">Bold ⌘B</div>
        <div data-action="italic">Italic ⌘I</div>
      </div>
    </div>
    <div class="menu" data-menu="View">View
      <div class="dropdown">
        <div data-action="togglePreview">Toggle Preview ⌘P</div>
      </div>
    </div>
  </div>
  <div class="window">
    <div class="toolbar"></div>
    <div id="container">
      <textarea id="editor" class="visible" placeholder="Write Markdown..."></textarea>
      <div id="preview"></div>
    </div>
  </div>

<script>
  // Markdown renderer
  function renderMD(md) {
    return md.replace(/^# (.*$)/gm,'<h1>$1</h1>')
             .replace(/^\> (.*$)/gm,'<blockquote>$1</blockquote>')
             .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
             .replace(/\*(.*?)\*/g,'<i>$1</i>')
             .replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank">$1</a>')
             .replace(/\n/g,'<br>');
  }

  // IndexedDB setup
  const dbName='markdownDB', store='files'; let db;
  function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(dbName,1);r.onerror=()=>rej();r.onsuccess=()=>{db=r.result;res();};r.onupgradeneeded=e=>{db=e.target.result;db.createObjectStore(store,{keyPath:'name'});}});}
  async function saveFile(n,c){const tx=db.transaction(store,'readwrite');tx.objectStore(store).put({name:n,content:c});}
  async function getAll(){const tx=db.transaction(store,'readonly');return tx.objectStore(store).getAll();}
  async function getFile(n){const tx=db.transaction(store,'readonly');return tx.objectStore(store).get(n);}

  openDB().then(init);

  const editor=ele('editor'), preview=ele('preview'), toolbar=ele('toolbar');
  let current = null;

  function ele(id){return document.getElementById(id);}

  async function init(){
    editor.addEventListener('input',()=>{preview.innerHTML=renderMD(editor.value);if(current)saveFile(current,editor.value);});
    await loadFiles();
  }

  async function loadFiles(){
    const list = await getAll();
    if(!list.length) return;
    current = list[0].name;
    const f = await getFile(current);
    editor.value = f?.content || '';
    preview.innerHTML = renderMD(editor.value);
  }

  function newFile(){
    const n = prompt('New filename:');
    if(!n) return;
    current = n; editor.value = ''; preview.innerHTML = ''; saveFile(n,'');
  }

  function bold() {wrapSel('**');}
  function italic(){wrapSel('*');}
  function wrapSel(tag){const s=editor.selectionStart,e=editor.selectionEnd,t=editor.value.slice(s,e);editor.setRangeText(tag+t+tag,s,e,'end');editor.dispatchEvent(new Event('input'));}

  function togglePreview(){
    if(preview.classList.contains('visible')){
      preview.classList.remove('visible'); editor.classList.add('visible');
    } else {
      preview.classList.add('visible'); editor.classList.remove('visible');
    }
  }

  document.body.addEventListener('click', e=>{
    const act = e.target.dataset.action;
    if(!act) return;
    handlers[act]?.();
  });

  const handlers = { new: newFile, open: loadFiles, save: ()=>current&&saveFile(current,editor.value), bold, italic, togglePreview };

  document.addEventListener('keydown', e=>{
    if(!e.metaKey) return;
    switch(e.key.toLowerCase()){
      case 'n': e.preventDefault(); newFile(); break;
      case 'o': e.preventDefault(); loadFiles(); break;
      case 's': e.preventDefault(); current&&saveFile(current,editor.value); break;
      case 'b': e.preventDefault(); bold(); break;
      case 'i': e.preventDefault(); italic(); break;
      case 'p': e.preventDefault(); togglePreview(); break;
    }
  });

  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
